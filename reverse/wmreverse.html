<head>
    <!-- <meta name="monetization" content="1KUrv2Ns8SwNkLgVKrVbSHJmdXLpsEvaDf"> -->
    <style>
      * {
        box-sizing: border-box;
      }
      
      /* Create three equal columns that floats next to each other */
      .column {
        float: left;
        width: 33.33%;
        padding: 10px;
        height: 300px; /* Should be removed. Only for demonstration */
      }
      
      /* Clear floats after the columns */
      .row:after {
        content: "";
        display: table;
        clear: both;
      }
    </style>

    <script>
      const MAX_SPEND = 5000
      const FEE = 800
      const SAT_PER_CENT = 5000
      let sessionId = null
      let payTo = "" //"133hMAzFDT4R8KRUqoQggv1UvcuyePzRn5"
      let total = 0
      let sendAmount = 0
      let scale

      function showMonetizationState (newState) {
        // console.log(newState)
        document.getElementById('state').innerText 
          = newState || document.monetization.state
      }
  
      if (document.monetization) {
        document.monetization.addEventListener('monetizationstop', showMonetizationState)
        document.monetization.addEventListener('monetizationpending', showMonetizationState)
        document.monetization.addEventListener('monetizationstart', showMonetizationState)
      }
  
      window.addEventListener('load', () => {
        document.getElementById('address').value = payTo
        if (!document.monetization) {
          document.getElementById('state').innerText = 'Not enabled in browser'
        } else {
          showMonetizationState()
        }
  
        const stopButton = document.getElementById('stop-button')
        const startButton = document.getElementById('start-button')
        const monetizationTag = document.querySelector('meta[name="monetization"]')

        var myTimer = null

        async function stopSession(stopNow, payment) {
          let pay = payment
          clearInterval(myTimer)
          if (!stopNow) {
            // this does a final spend and may loop
            pay = await onSendMoney('stop')
          }
          console.log(pay)
          if (pay && pay.txid) {
            document.getElementById('payout').innerText 
              = `This site paid you. See tx ${pay.txid}`
          }
          this.showMonetizationState(`stopped`)
        }

        stopButton.addEventListener('click', async () => {
          await stopSession()
          stopButton.disabled = true
          startButton.disabled = false
        })

        function startSession() {
          const enteredPayTo = document.getElementById('address').value
          if (!enteredPayTo) {
            showMonetizationState(`Enter a paymail first!`)
            return false
          } else {
            payTo = enteredPayTo
            showMonetizationState(`starting...`)
            sessionId = create_UUID()
            console.log(`session ${sessionId}`)
            myTimer = setInterval(onSendMoney, 2000)
            return true
          }
        }
  
        startButton.addEventListener('click', () => {
          if (startSession()){
            stopButton.disabled = false
            startButton.disabled = true
          }
        })

        async function onSendMoney(method) {
          // authorize faucet to send money to user
          const dto = {
            session: sessionId,
            payTo: payTo
          }
          const methodToCall = method || 'progress'
          let url = `https://cash.bitcoinofthings.com/faucet/${methodToCall}`
          const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dto)
          })
          const data = await response.json()
          console.log(data)
          sendAmount = data.amount
          whenReverseMonetizationProgress(data)
          return data
        }

        function whenReverseMonetizationProgress(payment) {
        // initialize currency and scale on first progress event
        if (total === 0) {
          scale = payment.assetScale || 8
          document.getElementById('currency').innerText 
            = 'cents' //payment.assetCode || 'BSV'
        }
        this.showMonetizationState(payment.returnResult)
        // amount is the total cumulative amount
        total = Math.max(Number(payment.amount)-FEE, 0)
        // const formatted = (total * Math.pow(10, -scale)).toFixed(scale)
        const formattedCents = total / SAT_PER_CENT
        document.getElementById('total').innerText = formattedCents
        if (payment.amount > MAX_SPEND) {
          stopSession(true, payment)
        }
      }

      })


    function create_UUID(){
      var dt = new Date().getTime()
      var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = (dt + Math.random()*16)%16 | 0
          dt = Math.floor(dt/16)
          return (c=='x' ? r :(r&0x3|0x8)).toString(16)
      })
      return uuid
    }

    </script>
  </head>
  
  <body>
    <div>
      Your paymail (or bitcoin address): <input id="address" type="text" required value=""/>
    </div>
    <div id="loading">
      Current Monetization State: <span id="state"></span>
    </div>
    <p>
      You have received
      <span id="total">nothing (yet)</span>
      <span id="currency"></span>
    </p>
    <div id="loading">
      <span id="payout"></span>
    </div>
  
    <p>
      <button id="stop-button" disabled>Stop Watching</button>
      <button id="start-button" >Start Watching</button>
    </p>

    <div class="row">
      <div class="column" style="background-color:white;">
            <iframe src="https://www.imdb.com/videoembed/vi652083481" allowfullscreen width="100%" height="100%"></iframe>
      </div>
        
    </div>

  </body>
