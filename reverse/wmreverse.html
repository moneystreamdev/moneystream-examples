<head>
    <!-- <meta name="monetization" content="1KUrv2Ns8SwNkLgVKrVbSHJmdXLpsEvaDf"> -->
    <title>MoneyStream reverse metering example</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <style>
      * {
        box-sizing: border-box;
      }
      
      /* Create three equal columns that floats next to each other */
      .column {
        float: left;
        width: 33.33%;
        padding: 10px;
        height: 300px; /* Should be removed. Only for demonstration */
      }
      
      /* Clear floats after the columns */
      .row:after {
        content: "";
        display: table;
        clear: both;
      }

      .hide {
        display: none;
      }
    </style>

    <script src="utils.js"></script>

  </head>
  
  <body>
    <div class="container">
      <div class="row mt-3">
        <div class="input-group mb-3">
          <div>
            Your paymail (or bitcoin address): <input id="address" type="text" 
                required value="fullcycle@moneybutton.com"
                onblur = "whenEnterPaymail()"
              />
          </div>
        </div>
      <div class="input-group mb-3">
        <div id="loading">
          Current Monetization State: <span id="state"></span>
        </div>
      </div>
      <div class="input-group mb-3">
        <p>
        You have received
        <span id="total">nothing (yet)</span>
        <span id="currency"></span>
        </p>
      </div>
      <div class="input-group mb-3">
        <div id="divPayout">
          <span id="payout"></span>
        </div>
      </div>
    
      <div class="hide">
        <button id="stop-button" class="btn" disabled>Stop Watching</button>
        <button id="start-button" class="btn" >Start Watching</button>
      </div>

      <div class="row">
        <div class="column" style="background-color:white;">
          <div id="player"></div>
        </div>
      </div>

      </div>
    </div>


      <script>

        const isLocal = false
        let faucet_url = `https://cash.bitcoinofthings.com/faucet/`
        let payTo = "" //"133hMAzFDT4R8KRUqoQggv1UvcuyePzRn5"
        if (isLocal) {
          faucet_url = `http://localhost:9900/faucet/`
          payTo = "fullcycle@moneybutton.com"
        }
        const MAX_SPEND = 5500
        const FEE = 800
        const SAT_PER_CENT = 5000
        let sessionId = null
        let total = 0
        let sendAmount = 0
        let scale
  
        function showMonetizationState (newState) {
          // console.log(newState)
          document.getElementById('state').innerText 
            = newState || document.monetization.state
        }
    
        if (document.monetization) {
          document.monetization.addEventListener('monetizationstop', showMonetizationState)
          document.monetization.addEventListener('monetizationpending', showMonetizationState)
          document.monetization.addEventListener('monetizationstart', showMonetizationState)
        }
  
        function whenEnterPaymail() {
            console.log(`player`)
            makePlayer()
          }
  
          var player;
          function makePlayer() {
            // 2. This code loads the IFrame Player API code asynchronously.
            var tag = document.createElement('script');
  
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
          }
  
          // 3. This function creates an <iframe> (and YouTube player)
          //    after the API code downloads.
          function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
              height: '240',
              width: '426',
              videoId: '4Wf00i7EKho',
              events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
              }
            });
          }
  
          // 4. The API will call this function when the video player is ready.
          function onPlayerReady(event) {
            //event.target.playVideo();
          }
  
          // 5. The API calls this function when the player's state changes.
          // -1 – unstarted
          // 0 – ended
          // 1 – playing
          // 2 – paused
          // 3 – buffering
          // 5 – video cued
          var done = false;
          function onPlayerStateChange(event) {
            console.log(event)
            if (event.data == YT.PlayerState.PLAYING && !done) {
              // setTimeout(stopVideo, 6000);
              // done = true;
              monetizationStart()
            }
            if (event.data == YT.PlayerState.ENDED && !done) {
              // setTimeout(stopVideo, 6000);
              // done = true;
              monetizationStop()
            }
          }
          // use these to control video playing
          function stopVideo() {
            player.stopVideo();
          }
          function playVideo() {
            player.playVideo();
          }
  
  ////////////////////////////////
  
        // window.addEventListener('load', () => {
  
          document.getElementById('address').value = payTo
          if (!document.monetization) {
            document.getElementById('state').innerText = 'Not enabled in browser'
          } else {
            showMonetizationState()
          }
    
          const stopButton = document.getElementById('stop-button')
          const startButton = document.getElementById('start-button')
          const monetizationTag = document.querySelector('meta[name="monetization"]')
  
          var myTimer = null
  
          function showPayout(payoutDescription) {
            document.getElementById('payout').innerText 
                = payoutDescription
          }
  
          async function stopSession(stopImmediately, payment) {
            let pay = payment
            clearInterval(myTimer)
            if (!stopImmediately) {
              // this does a final spend and may loop
              pay = await onSendMoney('stop')
            }
            console.log(pay)
            if (pay && pay.txid) {
              showPayout(`This site paid you. See tx ${pay.txid}`)
            }
            stopUI()
          }
  
          stopButton.addEventListener('click', async () => {
            await monetizationStop()
          })
  
          async function monetizationStop() {
            await stopSession(false)
            stopUI()
          }
  
          function stopUI() {
            showMonetizationState(`stopped`)
            stopVideo()
            stopButton.disabled = true
            startButton.disabled = false
          }
  
          function startSession() {
            const enteredPayTo = document.getElementById('address').value
            if (!enteredPayTo) {
              showMonetizationState(`Enter a paymail first!`)
              return false
            } else {
              payTo = enteredPayTo
              showMonetizationState(`starting...`)
              showPayout('')
              sessionId = create_UUID()
              console.log(`session ${sessionId}`)
              myTimer = setInterval(onSendMoney, 3000)
              playVideo()
              return true
            }
          }
    
          startButton.addEventListener('click', () => {
            monetizationStart()
          })
  
          function monetizationStart() {
            if (startSession()){
              stopButton.disabled = false
              startButton.disabled = true
            }
          }
  
          async function onSendMoney(method) {
            // authorize faucet to send money to user
            const dto = {
              session: sessionId,
              payTo: payTo
            }
            const methodToCall = method || 'progress'
            const response = await fetch(`${faucet_url}${methodToCall}`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(dto)
            })
            const data = await response.json()
            console.log(data)
            if (data.returnResult && data.returnResult === 'success') {
              await stopSession(true, data)
            } else {
              if (data.returnResult && data.returnResult === 'failure'
                && data.resultDescription && data.resultDescription === 'error on back end') {
                await stopSession(true, data)
              } else {
                if (data.amount) sendAmount = data.amount
                  await whenReverseMonetizationProgress(data)
              }
            }
            return data
          }
  
          async function whenReverseMonetizationProgress(payment) {
            // initialize currency and scale on first progress event
            if (total === 0) {
              scale = payment.assetScale || 8
              document.getElementById('currency').innerText 
                = 'cents' //payment.assetCode || 'BSV'
            }
            showMonetizationState(payment.returnResult)
            // amount is the total cumulative amount
            total = Math.max(Number(payment.amount)-FEE, 0)
            // const formatted = (total * Math.pow(10, -scale)).toFixed(scale)
            const formattedCents = total / SAT_PER_CENT
            document.getElementById('total').innerText = formattedCents
            if (payment.amount > MAX_SPEND) {
              //stopSession(true, payment)
              await onSendMoney('stop')
            }
          }
  
        // })
      
      </script>
  
  </body>
